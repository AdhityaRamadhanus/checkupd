# gopatrol

[![Go Report Card](https://goreportcard.com/badge/github.com/AdhityaRamadhanus/gopatrol)](https://goreportcard.com/report/github.com/AdhityaRamadhanus/gopatrol)  

self-hosted endpoint monitoring daemon and status pages based on https://github.com/sourcegraph/checkup

<p>
  <a href="#installation">Installation |</a>
  <a href="#setting-up-gopatrol-with-fs">Setting FS |</a>
    <a href="#setting-up-gopatrol-with-s3">Setting S3 |</a>
  <a href="#setting-endpoints">Setting Endpoints |</a>
  <a href="#notifier-slack">Notifier |</a>
  <a href="#licenses">License</a>
  <br><br>
  <blockquote>
	gopatrol is self-hosted health checks and status pages, written in Go using checkup (instead of using them as dependency i decide to copy the file to this project) and grpc as backend.

  There is much work to do for this project to be complete. Use it carefully.

  gopatrol currently supports:

  - Checking HTTP endpoints
  - Checking TCP endpoints (TLS supported)
  - Checking of DNS services & record existence  
  - Storing results on S3 and local filesystem
  - Add and delete endpoints on the fly, you don't need to change the config file everytime you decide to add/delete an endpoint
  - Easy to setup and deploy minimalist status page (100% static)
  - Get notified via slack and email (soon)
  </blockquote>
</p>

Installation
----------- 
* git clone
* make
```bash
NAME:
   gopatrol-cli - Checkup server cli 

USAGE:
   gopatrol-cli [global options] command [command options] [arguments...]

VERSION:
   1.0.0

AUTHOR:
   Adhitya Ramadhanus <adhitya.ramadhanus@gmail.com>

COMMANDS:
     add-http  Add endpoints to checkup
     add-tcp   Add tcp endpoints to checkup
     check     list and check endpoints
     list      list endpoint
     delete    delete endpoint
     help, h   Shows a list of commands or help for one command

GLOBAL OPTIONS:
   --help, -h     show help
   --version, -v  print the version
```

```bash
NAME:
   gopatrol - gopatrol daemon 

USAGE:
   gopatrol [global options] command [command options] [arguments...]

VERSION:
   1.0.0

AUTHOR:
   Adhitya Ramadhanus <adhitya.ramadhanus@gmail.com>

COMMANDS:
     daemon       run daemon
     tls-daemon   run tls daemon
     setup        Setup Daemon and create status page
     status-page  Serve status page
     help, h      Shows a list of commands or help for one command

GLOBAL OPTIONS:
   --help, -h     show help
   --version, -v  print the version
```

### Setting up gopatrol with FS
All you need to do is setup configuration for daemon and status page

1. **Daemon Setup**
  ```bash
  $ gopatrol setup fs --url=<url to serve the page, with port ex: localhost:80, mycheckup.com:80>
  ```

  It will create three directories called caddy_config, checkup_config and statuspage. 

```
  └───statuspage
      └───css
          |   style.css
          |
      └───js
          |   app.min.js
          |
      └───images
          |
          |   ...
      └───logs
          |   ...
      |   index.html
      |
  └───caddy_config
      └───logs
          |   
          |   ...
      └───errors
          |   
          |   ...
      |   Caddyfile
      |
  └───checkup_config
      |   checkup.json
      |
  
```
  caddy_config contains Caddyfile, logs and errors folder for caddy webserver
  checkup_config contains checkup.json
  statuspage contains the status page web app

  Example of fs storage checkup.json generated by cli 
  ```json
  {
    "checkers": [],
    "storage": {
      "provider": "fs",
      "dir": "statuspage/logs/"
    }
  }
  ```

### Setting up gopatrol with S3
First you need S3 bucket for this and setting privileges for this bucket, unfortunately gopatrol doesn't support automatic provisioning like checkup so you have to do manual provision https://github.com/sourcegraph/checkup/wiki/Provisioning-S3-Manually

Then, just like with the FS, you need to setup configuration for daemon and status page
```bash
$ gopatrol setup s3 --i=<s3 AccessKeyID> --k=<s3 SecretKey> --r=<s3 Region> --b=<s3 Bucket Name> --url=<url to serve the page, with port ex: localhost:80, mycheckup.com:80>
```
It will create three directories called caddy_config, checkup_config and statuspage. 

```
  └───statuspage
      └───css
          |   style.css
          |
      └───js
          |   app.min.js
          |
      └───images
          |
          |   ...
      └───logs
          |   ...
      |   index.html
      |
  └───caddy_config
      └───logs
          |   
          |   ...
      └───errors
          |   
          |   ...
      |   Caddyfile
      |
  └───checkup_config
      |   checkup.json
      |
  
```
  caddy_config contains Caddyfile, logs and errors folder for caddy webserver
  checkup_config contains checkup.json
  statuspage contains the status page web app

  Example of s3 checkup.json generated by cli 
  ```json
  {
    "checkers":[],
    "storage": {
      "provider": "s3",
      "access_key_id": "<yours>",
      "secret_access_key": "<yours>",
      "bucket": "<yours>",
      "region": "us-east-1"
    }
  }
  ```

Running Daemon
---------------
```bash
$ gopatrol daemon 10s
```

Serve Status Page
---------------
```bash
$ gopatrol status-page --config=<Path to caddyfile, default to caddy_config/Caddyfile> 
```
![checkup](https://cloud.githubusercontent.com/assets/5761975/25096466/888ca154-23ca-11e7-910d-59be4c610989.png)

Setting Endpoints
----------------
You can manually add endpoints to the generated checkup.json (see Setting up gopatrol with FS or S3)

Example of such configuration

```json
{
	"checkers": [{
		"type": "http",
		"endpoint_name": "Example HTTP",
		"endpoint_url": "http://www.example.com",
		"attempts": 5
	},
	{
		"type": "tcp",
		"endpoint_name": "Example TCP",
		"endpoint_url": "example.com:80",
		"attempts": 5
	},
	{
		"type": "tcp",
		"endpoint_name": "Example TCP with TLS enabled and a valid certificate chain",
		"endpoint_url": "example.com:443",
		"attempts": 5,
		"tls": true
	},
	{
		"type": "tcp",
		"endpoint_name": "Example TCP with TLS enabled and a self-signed certificate chain",
		"endpoint_url": "example.com:8443",
		"attempts": 5,
		"timeout": "2s",
		"tls": true,
		"tls_ca_file": "testdata/ca.pem"
	},
	{
		"type": "tcp",
		"endpoint_name": "Example TCP with TLS enabled and verification disabled",
		"endpoint_url": "example.com:8443",
		"attempts": 5,
		"timeout": "2s",
		"tls": true,
		"tls_skip_verify": true
	},
	{
		"type": "dns",
		"endpoint_name": "Example DNS test of endpoint_url looking up host.example.com",
		"endpoint_url": "ns.example.com:53",
		"hostname_fqdn": "host.example.com",
		"timeout": "2s"
	}],
	"storage": {
		"provider": "s3",
		"access_key_id": "<yours>",
		"secret_access_key": "<yours>",
		"bucket": "<yours>",
		"region": "us-east-1"
	}
}
```

Or you can add them on the fly when the daemon run

1. Adding Tcp endpoint
```bash
NAME:
   gopatrol-cli add-tcp - Add tcp endpoints to checkup

USAGE:
   gopatrol-cli add-tcp [command options] name url

OPTIONS:
   --tls                              Send request over tls
   --host value                       grpc server address (default: "/tmp/gopatrol.sock")
   --attempts value, -a value         how many times to check endpoint (default: 5)
   --thresholdrtt value, --rtt value  Threshold Rtt to define a degraded endpoint (default: 0)
   --tls-enabled                      Enable TLS connection to endpoint
   --tls-ca value                     Certificate file to established tls connection
   --tls-skip-verify                  Skip verify tls certificate
   --timeout value                    Timeout to established a tls connection (default: 3000000000)
```

2. Adding Http endpoint
```bash
NAME:
   gopatrol-cli add-http - Add endpoints to checkup

USAGE:
   gopatrol-cli add-http [command options] name url

OPTIONS:
   --tls                              Send request over tls
   --host value                       grpc server address (default: "/tmp/gopatrol.sock")
   --attempts value, -a value         how many times to check endpoint (default: 5)
   --thresholdrtt value, --rtt value  Threshold Rtt to define a degraded endpoint (default: 0)
   --mustcontain value                HTML content that a page should contain to determine whether a page is up or down
   --mustnotcontain value             HTML content that a page should not contain to determine whether a page is up or down
   --headers value                    Http Headers to send along the check request
   --upstatus value                   Http status code to define a healthy page (default: 200)

```

3. Adding DNS endpoint
```bash
NAME:
   gopatrol-cli add-dns - Add dns endpoints to checkup

USAGE:
   gopatrol-cli add-dns [command options] name url hostname

OPTIONS:
   --tls                              Send request over tls
   --host value                       grpc server address (default: "/tmp/gopatrol.sock")
   --attempts value, -a value         how many times to check endpoint (default: 5)
   --thresholdrtt value, --rtt value  Threshold Rtt to define a degraded endpoint (default: 0)
   --timeout value                    Timeout to established a tls connection (default: 3000000000)
```

Just like adding endpoint, you can either modify the checkup.json or delete them through cli

1. Deleting Endpoint
```bash
NAME:
   gopatrol-cli delete - delete endpoint

USAGE:
   gopatrol-cli delete [command options] url

OPTIONS:
   --tls         Send request over tls
   --host value  grpc server address (default: "/tmp/gopatrol.sock")
```

List Endpoint
------------------------
```bash
NAME:
   gopatrol-cli list - list endpoint

USAGE:
   gopatrol-cli list [command options] [arguments...]

OPTIONS:
   --tls         Send request over tls
   --host value  grpc server address (default: "/tmp/gopatrol.sock")
```

Check Endpoint
------------------------
```bash
NAME:
   gopatrol-cli check - list and check endpoints

USAGE:
   gopatrol-cli check [command options] [arguments...]

OPTIONS:
   --tls         Send request over tls
   --host value  grpc server address (default: "/tmp/gopatrol.sock")
```

Notifier (Slack)
----------------
* To use this notifier you need bot integration in your team and channel id where this bot will notify you, refer to this link https://api.slack.com/bot-users
* Add notifier section to the generated checkup.json
* Example of checkup.json 
```json
{
	"checkers": [{
		"type": "tcp",
		"endpoint_name": "redis",
		"endpoint_url": "localhost:6379",
		"attempts": 5
	}],
	"storage": {
		"provider": "fs",
		"dir": "./checkup_config/logs"
	},
  "notifier": {
      "name": "slack",
      "token": "your token",
      "channel": "your channel id"
  }
}
```


Todo
-----------
* Embedding Caddy
* Email Notifier

License
----

MIT © [Adhitya Ramadhanus]

